<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.edu.module.dao.ArchiveAssessDao">

    <insert id="insertArchiveAccess1" useGeneratedKeys="true" keyProperty="id" parameterType="net.edu.module.entity.ArchiveAssessEntity">
        insert into archive_assess (name,create_time)
        values (#{name},now())
    </insert>
    <update id="updateArchiveAssess1">
        update archive_assess
        set name=#{name}
        where id=#{id}
    </update>
    <update id="updateArchiveAssess2">
        update archive_weight_target_assess
        set assess_id=#{assessId},target_id=#{targetId},course_id=#{courseId}
        where assess_id=#{id}
    </update>


    <select id="selectArchiveAssessByPage" resultType="net.edu.module.vo.ArchiveAssessVO">
        SELECT
        t1.id AS id,
        t1.name AS name ,
        t3.target_id AS targetId,
        t3.course_id AS courseId,
        t3.weight AS weight,
        t3.assess_id as assessId,
        ( SELECT name FROM archive_target t2 WHERE t3.target_id = t2.id ) AS targetName,
        ( SELECT name FROM archive_course t4 WHERE t3.course_id = t4.id ) AS courseName,
        ( SELECT grade FROM archive_target t2 WHERE t3.target_id = t2.id ) AS grade,
        t3.weight_explain AS weightExplain,
        t1.creator,
        t1.version,
        t1.updater
        FROM
        archive_assess t1
        LEFT JOIN archive_weight_target_assess t3
        ON t1.id = t3.assess_id
        WHERE
        t1.deleted = 0
        <if test="query.getName()!=null and query.getName()!=''">
            and name like concat('%',#{query.name},'%')
        </if>
        <if test="query.getGrade()!=null and query.getGrade()!=''">
            and ( SELECT grade FROM archive_target t2 WHERE t3.target_id = t2.id) = #{query.grade}
        </if>
        <if test="query.getTargetName()!=null and query.getTargetName()!=''">
            and ( SELECT name FROM archive_target t2 WHERE t3.target_id = t2.id ) like concat('%',#{query.targetName},'%')
        </if>
        <if test="query.getCourseName()!=null and query.getCourseName()!=''">
            and ( SELECT name FROM archive_course t4 WHERE t3.course_id = t4.id ) like concat('%',#{query.courseName},'%')
        </if>
        order by
        grade desc,
        targetName asc,
        courseName asc
    </select>
    <select id="selectName" resultType="net.edu.module.vo.ArchiveAssessVO">
        SELECT
            id,
            name
        FROM
	        archive_assess
        WHERE
	        deleted =0
    </select>
    <select id="selectArchiveAssessById" resultType="net.edu.module.vo.ArchiveAssessVO">
        SELECT
        t1.id AS id,
        t1.name AS name ,
        t3.target_id AS targetId,
        t3.course_id AS courseId,
        t3.weight AS weight,
        t3.assess_id as assessId,
        ( SELECT name FROM archive_target t2 WHERE t3.target_id = t2.id ) AS targetName,
        ( SELECT name FROM archive_course t4 WHERE t3.course_id = t4.id ) AS courseName,
        ( SELECT grade FROM archive_target t2 WHERE t3.target_id = t2.id ) AS grade,
        t3.weight_explain AS weightExplain,
        t1.creator,
        t1.version,
        t1.updater
        FROM
        archive_assess t1
        LEFT JOIN archive_weight_target_assess t3
        ON t1.id = t3.assess_id
        WHERE
        t1.id=#{id}
    </select>

    <select id="selectWeightById" resultType="net.edu.module.vo.ArchiveAssessVO">
        select name,weight from archive_assess
        where deleted=0 and course_id=#{id}
    </select>
</mapper>
