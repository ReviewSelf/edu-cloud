<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.edu.module.dao.ArchiveCourseSummaryDao">
    <insert id="insertSummaryTable" useGeneratedKeys="true" keyProperty="id" parameterType="net.edu.module.vo.ArchiveCourseSummaryVO">
        insert into archive_course_summary(course_id)
        values (#{courseId})
    </insert>
    <insert id="insertAssessScore">
        INSERT INTO archive_assess_score(stu_id , stu_name , score , course_id , assess_id , summary_id)
        VALUES (#{stuId} , #{stuName} , #{score} , #{courseId} , #{assessId} , #{summaryId})
    </insert>

    <update id="insertMeasures">
        update archive_course_summary set improvement = #{improvement}
        where id = #{id}
    </update>

    <update id="insertAnalysis">
        update archive_course_summary set analysis_description = #{analysisDescription}
        where id = #{id}
    </update>

    <update id="insertFinal">
        update archive_course_summary set problem = #{problem},
                                          measures = #{measures},
                                          resources = #{resources},
                                          deleted = 0
        where id = #{id}
    </update>

    <select id="selectSummaryByPage" resultType="net.edu.module.vo.ArchiveCourseSummaryVO">
        select id,course_id as courseId,create_time as createTime
        from archive_course_summary
        where deleted = 0
        order by create_time desc
    </select>
    <select id="selectStudent" resultType="java.lang.Integer">
        SELECT
            COUNT(*)
        FROM archive_test_score
        GROUP BY test_id limit 1
    </select>
    <select id="selectStudentId" resultType="java.lang.String">
        SELECT
            stu_id
        FROM archive_test_score
        group by stu_id
    </select>
    <select id="selectStudentIdAndWeight" resultType="net.edu.module.vo.ArchiveAssessTestGradesVo">
        SELECT
            id,
            weight,
            assess_id
        FROM archive_weight_assess_test
        WHERE course_id = #{courseId} and deleted = 0
    </select>
    <select id="selectStudentTestScore" resultType="net.edu.module.vo.ArchiveAssessTestGradesVo">
        SELECT
            t1.score,
            t1.test_id as id,
            t1.stu_id as stuId,
            t1.stu_name as stuName
        FROM archive_test_score t1
                 LEFT JOIN archive_weight_assess_test t2 ON t1.test_id = t2.id
        WHERE t2.assess_id = #{assessId} and t2.course_id = #{courseId}
    </select>
    <select id="selectAssessNum" resultType="java.lang.Integer">
        SELECT
            count(*)
        FROM archive_assess
        WHERE course_id = #{courseId} and deleted = 0
    </select>
    <select id="selectAssessId" resultType="java.lang.Integer">
        SELECT
            id
        FROM archive_assess
        WHERE course_id = #{courseId} and deleted = 0
    </select><select id="selectStudentName" resultType="java.lang.String">
       SELECT
            stu_name
        FROM archive_test_score
        WHERE deleted = 0
        GROUP BY stu_id
   </select>
    <select id="selectAssessName" resultType="java.lang.String">
       SELECT
        name
       FROM archive_assess
       WHERE course_id = #{courseId} and deleted = 0
    </select>
    <select id="selectStudentAssessScore" resultType="java.lang.String">
       SELECT
       score
       FROM archive_assess_score
       WHERE assess_id = #{assessId} and stu_id = #{stuId} and deleted = 0 and summary_id = #{summaryId}
      </select>
    <select id="selectAssessScore" resultType="java.lang.Integer">
        SELECT
            SUM(SCORE)
        FROM archive_assess_score
        WHERE summary_id = #{summaryId} and course_id = #{courseId}
        GROUP BY assess_id
    </select>
    <select id="selectMannerPq" resultType="java.math.BigDecimal">
        SELECT
            SUM(weight)
        FROM archive_assess_manner
        WHERE deleted = 0
        GROUP BY manner_kind
    </select>
    <select id="selectStudentIdAndName" resultType="net.edu.module.vo.ArchiveAssessTestGradesVo">
         select
    stu_id as studentId,
    stu_name as studentName
from archive_test_score
where course_id = #{courseId}
group by stu_id, stu_name
    </select>
    <select id="selectFinalScore" resultType="net.edu.module.vo.ArchiveAssessTestScoreVo">
       select
    score as assessScore from archive_assess_score t1
    where (select manner_kind from archive_assess_manner where t1.assess_id = assess_id limit 1) = 2 and t1.stu_id = #{stuId} and t1.summary_id = #{summaryId}
    order by assess_id
    </select><select id="selectPeaceScore" resultType="net.edu.module.vo.ArchiveAssessTestScoreVo">
    select
    t1.score as assessScore,
       t2.weight
from archive_assess_score t1
    left join archive_assess t2 on t2.id = t1.assess_id
    where (select manner_kind from archive_assess_manner where t1.assess_id = assess_id limit 1) = 1 and t1.stu_id = #{studentId} and t1.summary_id = #{summaryId}
   </select>

    <select id="selectCourseIdBySummaryId" resultType="java.lang.Long">
        select course_id from archive_course_summary where id = #{summaryId}
    </select>
</mapper>
