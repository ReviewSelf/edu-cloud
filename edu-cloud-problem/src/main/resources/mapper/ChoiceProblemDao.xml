<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.edu.module.dao.ChoiceProblemDao">
    <select id="selectChoiceProblem" resultType="net.edu.module.vo.ChoiceProblemVO">
<!--        select id,type,name,description,source,tips,advice_time,img,difficulty,kp_id as kpId-->
<!--               ,(select name from knowledge_point where id=kp_id limit 1) as kpName,submit_times-->
<!--               ,correct_times as correctTimes,is_typical as isTypical,option_num as optionNum,used_num as usedNum,-->
<!--                -->
<!--        from problem_choice where deleted = 0-->
<!--        order by status asc,update_time desc-->
    </select>


    <select id="page" resultType="net.edu.module.vo.ChoiceProblemVO">
        select id,type,name,description,source,tips,advice_time as adviceTime,img,difficulty,kp_id as kpId
        ,(select name from knowledge_point where id=kp_id limit 1) as kpName,submit_times as submitTimes
        ,correct_times as correctTimes,is_typical as isTypical,option_num as optionNum,used_num as usedNum,
        create_time as createTime,creator,status
        from problem_choice where deleted = 0
        <if test="query.getType()!=null">
            and  type = #{query.type}
        </if>
        <if test="query.getName()!='' and query.getName()!=null">
            and  name like concat('%',#{query.name},'%')
        </if>
        <if test="query.getDifficulty()!=null">
            and difficulty =#{query.difficulty}
        </if>
        <if test="query.getKpId()!=null">
            and kp_id = #{query.kpId}
        </if>
        <if test="query.getStatus()!=null">
            and status = #{query.status}
        </if>
        <if test="query.getIsTypical()!=null">
            and is_typical = #{query.isTypical}
        </if>
        order by status asc,update_time desc
    </select>

    <update id="updateStatus" >
        update problem_choice set status=abs(status-1) where id=#{id}
    </update>


    <select id="selectOption" resultType="net.edu.module.vo.ChoiceOptionVO">
        select id,problem_id as problemId,problem_option as problemOption, is_true as isTrue
        from problem_choice_options where deleted = 0 and problem_id = #{id}
    </select>


    <delete id="deleteOption">
        delete from problem_choice_options where problem_id = #{id};
    </delete>

    <insert id="insertOption">
        insert  into problem_choice_options(problem_id,problem_option,is_true) values(#{vo.problemId},#{vo.problemOption},#{vo.isTrue})
    </insert>

    <update id="updateOptionNum">
        update  problem_choice set option_num = (select sum(1) from problem_choice_options where problem_id = #{id} and deleted = 0)  where id = #{id}
    </update>
</mapper>