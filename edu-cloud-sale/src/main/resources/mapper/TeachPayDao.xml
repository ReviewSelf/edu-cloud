<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.edu.module.dao.TeachPayDao">

    <resultMap type="net.edu.module.entity.TeachPayEntity" id="teachPayMap">
        <result property="id" column="id"/>
        <result property="payment" column="payment"/>
        <result property="payable" column="payable"/>
        <result property="discount" column="discount"/>
        <result property="userId" column="user_id"/>
        <result property="time" column="time"/>
        <result property="bz" column="bz"/>
    </resultMap>

    <select id="page" resultType="net.edu.module.vo.TeachPayVO">
        select
            t.id,
            t.user_id,
            s.real_name as realName,
            t.time,
            t.class_hours,
            t.present_hours,
            t.payable,
            t.handler,
            t.bz,
            t.status,
            t.class_type,
            t.present_type,
            (select real_name from sys_user p where s.sale_id = p.id) as saleName
        from teach_pay t
        left join sys_user s on t.user_id = s.id
        where s.deleted = 0
        <if test="query.getRealName()!=null and query.getRealName()!=''">
            and  s.real_name like concat('%',#{query.realName},'%')
        </if>
        <if test="query.getHandler()!=null and query.getHandler()!=''">
            and  t.handler like concat('%',#{query.handler},'%')
        </if>
        <if test="query.getSaleName()!=null and query.getSaleName()!=''">
            and  (select real_name from sys_user p where s.sale_id = p.id) like concat('%',#{query.saleName},'%')
        </if>
        <if test="query.getStatus()!=null and query.getStatus()!=''">
            <if test="query.getStatus() == 1">
               and t.payment &gt;= #{query.status}
            </if>
            <if test="query.getStatus() == -1">
               and t.payment &lt; #{query.status}
            </if>
        </if>
        order by time desc
    </select>

    <select id="getPaymentDetail" resultType="net.edu.module.vo.TeachPayVO">
        select
            t.id,
            s.real_name as realName,
            s.stu_number,
            s.mobile,
            s.urgent_identity,
            t.time,
            t.class_hours,
            t.present_hours,
            t.payment,
            t.discount,
            t.payable,
            t.class_type,
            t.present_type,
            t.handler,
            t.bz,
            t.status,
            (select real_name from sys_user p where s.sale_id = p.id) as saleName
        from teach_pay t
        left join sys_user s on t.user_id = s.id
        where t.id = #{id}
    </select>

    <select id="statisticsAmount" resultType="hashmap">
        select
            SUM(payment) as amount ,handler
        from teach_pay
        WHERE DATE_FORMAT(time,'%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m')
        group by handler
    </select>

    <select id="statisticsPeople" resultType="hashmap">
        select count(user_id) as num,handler from
            (select user_id,handler from teach_pay
             WHERE DATE_FORMAT(time,'%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m') and payment>0
             group by user_id,handler) as t
        group by handler
        ORDER BY `handler`
    </select>

</mapper>