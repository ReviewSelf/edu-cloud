<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.edu.module.dao.UserDao">

	<select id="selectStudentByPage" resultType="net.edu.module.vo.UserVO">
		SELECT
		t1.id,
		t1.username,
		t1.real_name,
		t1.gender,
		t1.email,
		t1.mobile,
		t1.sale_status,
		t1.address,
		t1.age,
		t1.grade,
		t1.area,
		t2.role_id,
		t1.sale_id,
		t1.reading_school,
		t1.urgent_identity,
		t1.urgent_phone,
		(select communicate_time from communicate t4 where t1.id = t4.stu_id
		                                             order by communicate_time desc limit 1)
		                                             as communicateTime,
		(select count(*) from communicate t4 where t1.id = t4.stu_id ) as communicate,
		t1.purpose_level,
		t1.purpose,
		(select real_name from sys_user t3 where t3.id = t1.sale_id) as saleName
		FROM
		sys_user t1
		LEFT JOIN sys_user_role t2 ON t1.id=t2.user_id
		WHERE
		t1.deleted = 0
		and t1.cadets = 0
		and t2.role_id = 2
		and t2.deleted = 0
		<if test="query.getUsername() != null and query.getUsername() != ''">
			and t1.username like concat(#{query.username},'%')
		</if>
		<if test="query.getBeginTime() != null and query.getBeginTime() != ''">
			and (select communicate_time from communicate t4 where t1.id = t4.stu_id
			order by communicate_time desc limit 1) between #{query.beginTime} and #{query.endTime}
		</if>
		<if test="query.getRealName() != null and query.getRealName() != ''">
			and t1.real_name like concat(#{query.realName},'%')
		</if>

	</select>

	<insert id="insertCadet" useGeneratedKeys="true" keyProperty="id">
		insert into sys_user
		(id,
		 username,
		 password,
		 real_name,
		 avatar,
		 gender,
		 email,
		 mobile,
		 org_id,
		 status,
		 address,
		 age,
		 grade,
		 integral,
		 balance,
		 area,
		 cadets,
		 sale_id,
		 union_id,
		 open_id,
		 create_time)
		values (  #{id}, #{username}, #{password},#{realName}, #{avatar}, #{gender},
		        #{email}, #{mobile}, #{orgId}, #{status} , #{address} ,
		        #{age}, #{grade}, #{integral}, #{balance}, #{area}, 0, #{saleId},
		        #{unionId},#{openId},now()
		        )

	</insert>
</mapper>
